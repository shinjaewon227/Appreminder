<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weather Forecast</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", Roboto, "Noto Sans KR", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            /* ì´ˆê¸° ë°°ê²½ (ì˜¤í›„) */
            background: linear-gradient(135deg, #6dd5fa 0%, #001f5b 100%);
            min-height: 100vh;
            color: white;
            transition: background 1.5s ease;
            overflow-x: hidden;
        }

        /* ì‹œê°„ëŒ€ë³„ í…Œë§ˆ */
        body.morning { background: linear-gradient(135deg, #FFDEE9 0%, #B5FFFC 100%); color: #4a4a4a; }
        body.afternoon { background: linear-gradient(135deg, #6dd5fa 0%, #001f5b 100%); color: white; }
        body.evening { background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); color: white; }

        /* 2. ë¡œë”© ìŠ¤í”¼ë„ˆ */
        #loading-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f2f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .spinner-svg { width: 50px; height: 50px; animation: rotate 2s linear infinite; }
        .spinner-circle {
            stroke: #3b82f6; stroke-width: 4;
            stroke-dasharray: 1, 200; stroke-dashoffset: 0;
            stroke-linecap: round; fill: none;
            animation: dash 1.5s ease-in-out infinite;
        }

        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash {
            0% { stroke-dasharray: 1, 200; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 89, 200; stroke-dashoffset: -35px; }
            100% { stroke-dasharray: 89, 200; stroke-dashoffset: -124px; }
        }

        /* 3. ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        #main-content {
            opacity: 0; padding: 24px; padding-bottom: 50px;
            transition: opacity 0.8s ease-in; display: none;
        }

        .header {
            display: flex; align-items: center; margin-bottom: 30px; padding-top: 10px;
        }

        .back-btn {
            background: none; border: none; cursor: pointer;
            padding: 8px; margin-left: -8px; color: inherit;
            display: flex; align-items: center;
        }
        .back-btn span { font-size: 28px; }

        .location-title { font-size: 18px; font-weight: 600; margin-left: 10px; }

        /* í˜„ì¬ ë‚ ì”¨ */
        .current-section {
            display: flex; flex-direction: column; align-items: center;
            margin-bottom: 40px; text-align: center;
        }
        .current-temp { font-size: 72px; font-weight: 200; letter-spacing: -2px; margin-bottom: -10px; }
        .current-desc { font-size: 20px; font-weight: 500; opacity: 0.9; margin-bottom: 10px; }
        .current-high-low { font-size: 14px; opacity: 0.8; }

        /* ì¹´ë“œ ê³µí†µ (Glassmorphism) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        body.morning .glass-panel {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.8); color: #333;
        }

        .section-title {
            font-size: 14px; font-weight: 600; opacity: 0.8;
            margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        
        .title-left { display: flex; align-items: center; gap: 5px; }
        .date-range { font-size: 12px; opacity: 0.7; font-weight: normal; }

        /* ì‹œê°„ëŒ€ë³„ ì˜ˆë³´ */
        .hourly-container {
            display: flex; overflow-x: auto; gap: 20px; padding-bottom: 10px;
            scrollbar-width: none;
        }
        .hourly-container::-webkit-scrollbar { display: none; }
        .hourly-item {
            display: flex; flex-direction: column; align-items: center;
            min-width: 50px; gap: 8px;
        }
        .hourly-time { font-size: 13px; opacity: 0.8; }
        .hourly-icon { width: 30px; height: 30px; object-fit: contain; }
        .hourly-temp { font-size: 16px; font-weight: 600; }

        /* [ìˆ˜ì •ë¨] ì£¼ê°„ ì˜ˆë³´ (í…ìŠ¤íŠ¸ ì¶”ê°€ë¨) */
        .daily-row {
            display: flex; align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255, 0.1);
        }
        body.morning .daily-row { border-bottom: 1px solid rgba(0,0,0, 0.05); }
        .daily-row:last-child { border-bottom: none; }

        .daily-day { 
            width: 50px; /* ìš”ì¼ ê³ ì • ë„ˆë¹„ */
            font-weight: 600; font-size: 15px; 
        }
        
        /* ë‚ ì”¨ ì•„ì´ì½˜ + í…ìŠ¤íŠ¸ ì˜ì—­ */
        .daily-condition { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding-left: 10px;
        }
        .daily-icon { width: 32px; height: 32px; }
        .daily-text { 
            font-size: 14px; 
            opacity: 0.9;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .daily-temp { 
            width: 80px; /* ì˜¨ë„ ì˜ì—­ ê³ ì • ë„ˆë¹„ */
            text-align: right; font-size: 15px; opacity: 0.9; 
        }
        .min-temp { opacity: 0.6; margin-right: 8px; }

        /* ë‰´ìŠ¤ ì•„ì´í…œ */
        .news-item { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .news-item:last-child { margin-bottom: 0; }
        .news-thumb {
            width: 50px; height: 50px; border-radius: 12px;
            background-color: rgba(0,0,0,0.1); display: flex;
            align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0;
        }
        .news-content { flex: 1; min-width: 0; }
        .news-headline { font-size: 15px; font-weight: 600; margin-bottom: 4px; line-height: 1.3; }
        .news-meta { font-size: 12px; opacity: 0.6; }

        /* ========================================= */
        /* [ì¶”ê°€ë¨] ì•ŒëŒ(Reminder) ê´€ë ¨ CSS ìŠ¤íƒ€ì¼ */
        /* ========================================= */
        #alarmOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%, #a18cd1 100%);
            background-size: 400% 400%; animation: gradientBG 10s ease infinite;
            z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .alarm-title { font-size: 32px; font-weight: 800; color: white; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .alarm-msg { font-size: 18px; color: rgba(255,255,255,0.9); margin-bottom: 50px; }
        .alarm-btn { width: 100%; max-width: 280px; padding: 18px; border-radius: 30px; border: none; font-size: 18px; font-weight: 700; margin-bottom: 16px; cursor: pointer; }
        .stop-btn { background: white; color: #f04452; }
        .snooze-btn { background: rgba(255,255,255,0.3); color: white; backdrop-filter: blur(5px); }

        /* ì•Œë¦¼ ëª¨ë‹¬ (ì¬ì•Œë¦¼ í™•ì¸ ë“±) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; display: none; align-items: center; justify-content: center; }
        .custom-modal { background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 24px; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; color: #333; }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .success-icon { width: 60px; height: 60px; object-fit: contain; margin-bottom: 16px; display: none; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #333; }
        .modal-btn { width: 100%; padding: 14px; border-radius: 16px; border: none; background: #3182f6; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div id="alarmOverlay">
        <div class="alarm-title" id="alarmTitleText">ë¦¬ë§ˆì¸ë”</div>
        <div class="alarm-msg" id="alarmSubText">ì„/ë¥¼ í•  ì‹œê°„ì…ë‹ˆë‹¤.</div>
        <button class="alarm-btn stop-btn" onclick="stopAlarm()">ì¢…ë£Œ</button>
        <button class="alarm-btn snooze-btn" onclick="snoozeAlarm()">ì—°ê¸° (ì¬ì•Œë¦¼)</button>
    </div>

    <div id="alertModal" class="modal-overlay">
        <div class="custom-modal">
            <img src="icon/check.webp" class="success-icon" id="alertIcon" alt="Check">
            <div class="modal-title" id="alertMsg">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>
            <button class="modal-btn" onclick="closeAlert()">í™•ì¸</button>
        </div>
    </div>

    <div id="loading-screen">
        <svg class="spinner-svg" viewBox="0 0 50 50">
            <circle class="spinner-circle" cx="25" cy="25" r="20"></circle>
        </svg>
    </div>

    <div id="main-content">
        <div class="header">
            <button class="back-btn" onclick="location.href='app.html'">
                <span class="material-symbols-rounded">arrow_back_ios_new</span>
            </button>
            <div class="location-title" id="location-name">ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>
        </div>

        <div class="current-section">
            <div class="current-temp" id="now-temp">--Â°</div>
            <div class="current-desc" id="now-desc">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
            <div class="current-high-low">
                ìµœê³  <span id="today-high">--Â°</span>  ìµœì € <span id="today-low">--Â°</span>
            </div>
        </div>

        <div class="glass-panel">
            <div class="section-title">
                <div class="title-left">
                    <span class="material-symbols-rounded" style="font-size:18px;">schedule</span>
                    ì‹œê°„ëŒ€ë³„ ì˜ˆë³´
                </div>
            </div>
            <div class="hourly-container" id="hourly-list"></div>
        </div>

        <div class="glass-panel">
            <div class="section-title">
                <div class="title-left">
                    <span class="material-symbols-rounded" style="font-size:18px;">calendar_month</span>
                    ì£¼ê°„ ì˜ˆë³´
                </div>
                <div class="date-range" id="weekly-range-text"></div>
            </div>
            <div id="daily-list"></div>
        </div>

        <div class="glass-panel">
            <div class="section-title">
                <div class="title-left">
                    <span class="material-symbols-rounded" style="font-size:18px;">newspaper</span>
                    ì˜¤ëŠ˜ì˜ ìƒí™œ ë‚ ì”¨
                </div>
            </div>
            <div id="news-list"></div>
        </div>
    </div>

    <script>
        // =========================================
        // [ì¶”ê°€ë¨] ì•ŒëŒ ê´€ë ¨ ë³€ìˆ˜ ë° ì„¤ì •
        // =========================================
        const API_URL = 'https://jaewondev.pythonanywhere.com';
        const userName = localStorage.getItem('loginUser');
        let reminders = [];
        let activeAlarm = null;
        let snoozedAlarms = [];

        // ì•ŒëŒ ì†Œë¦¬ ì„¤ì •
        const sound1 = new Audio('https://drive.google.com/uc?export=download&id=1gR40urBgaolXetwLWWP6wQfVG80cGHrW');
        const sound2 = new Audio('https://drive.google.com/uc?export=download&id=1kIfvcsX7c6t_faDUYvW7wsYipnSOn8Ot');
        sound2.loop = true;

        window.onload = function() {
            setTimeTheme();
            getWeatherAndLocation();

            // [ì¶”ê°€ë¨] ë¦¬ë§ˆì¸ë” ë¡œë“œ ë° ì•ŒëŒ ì²´í¬ ì‹œì‘
            if (userName) {
                loadReminders();
                setInterval(checkAlarm, 1000);
            }
            
            // [ì¶”ê°€ë¨] ì˜¤ë””ì˜¤ ìë™ ì¬ìƒ ì œí•œ í•´ì œìš©
            document.body.addEventListener('touchstart', unlockAudio, { once: true });
            document.body.addEventListener('click', unlockAudio, { once: true });
        };

        function setTimeTheme() {
            const hour = new Date().getHours();
            const body = document.body;
            body.classList.remove('morning', 'afternoon', 'evening');
            if (hour >= 6 && hour < 12) body.classList.add('morning');
            else if (hour >= 12 && hour < 17) body.classList.add('afternoon');
            else body.classList.add('evening');
        }

        function getWeatherAndLocation() {
            if (!navigator.geolocation) {
                fetchData(37.5665, 126.9780, "ì„œìš¸íŠ¹ë³„ì‹œ");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => fetchData(pos.coords.latitude, pos.coords.longitude),
                () => fetchData(37.5665, 126.9780, "ì„œìš¸íŠ¹ë³„ì‹œ")
            );
        }

        async function fetchData(lat, lon, fallbackName = null) {
            try {
                // ì£¼ì†Œ í™•ì¸
                let locName = fallbackName;
                if (!locName) {
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&accept-language=ko`);
                        const geoData = await geoRes.json();
                        if (geoData.address) {
                            locName = geoData.address.borough || geoData.address.city || geoData.address.town || "í˜„ìœ„ì¹˜";
                            if(locName === "ì„œìš¸íŠ¹ë³„ì‹œ") locName = "ì„œìš¸";
                        }
                    } catch(e) { locName = "í˜„ìœ„ì¹˜"; }
                }
                document.getElementById('location-name').innerText = locName;

                // ë‚ ì”¨ ë°ì´í„° (Open-Meteo)
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
                const res = await fetch(weatherUrl);
                const data = await res.json();

                renderCurrentWeather(data);
                renderHourlyForecast(data);
                renderDailyForecast(data);
                renderNews(data);

                setTimeout(finishLoading, 800);

            } catch (err) {
                console.error(err);
                alert("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                finishLoading();
            }
        }

        function finishLoading() {
            const loader = document.getElementById('loading-screen');
            const content = document.getElementById('main-content');
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                content.style.display = 'block';
                setTimeout(() => content.style.opacity = '1', 50);
            }, 500);
        }

        function renderCurrentWeather(data) {
            const current = data.current;
            const daily = data.daily;
            const info = getWeatherInfo(current.weather_code);

            document.getElementById('now-temp').innerText = `${Math.round(current.temperature_2m)}Â°`;
            document.getElementById('now-desc').innerText = info.label;
            document.getElementById('today-high').innerText = `${Math.round(daily.temperature_2m_max[0])}Â°`;
            document.getElementById('today-low').innerText = `${Math.round(daily.temperature_2m_min[0])}Â°`;
        }

        function renderHourlyForecast(data) {
            const container = document.getElementById('hourly-list');
            container.innerHTML = '';
            const currentHour = new Date().getHours();

            for (let i = currentHour; i < currentHour + 24; i++) {
                if (!data.hourly.time[i]) break;
                const temp = Math.round(data.hourly.temperature_2m[i]);
                const code = data.hourly.weather_code[i];
                const info = getWeatherInfo(code);
                let hourVal = i % 24;
                let displayTime = (i === currentHour) ? "ì§€ê¸ˆ" : `${hourVal}ì‹œ`;
                
                container.innerHTML += `
                    <div class="hourly-item">
                        <span class="hourly-time">${displayTime}</span>
                        <img src="${info.icon}" class="hourly-icon" alt="${info.label}">
                        <span class="hourly-temp">${temp}Â°</span>
                    </div>`;
            }
        }

        function renderDailyForecast(data) {
            const container = document.getElementById('daily-list');
            container.innerHTML = '';
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            // 1. ë‚ ì§œ ë²”ìœ„ í‘œì‹œ ê³„ì‚° (ë‚´ì¼ ~ 6ì¼ í›„)
            if (data.daily.time.length > 6) {
                const startStr = data.daily.time[1]; // ë‚´ì¼
                const endStr = data.daily.time[6];   // 6ì¼ í›„
                
                const sDate = new Date(startStr);
                const eDate = new Date(endStr);
                
                // ì˜ˆ: 2.10 ~ 2.16
                const rangeText = `${sDate.getMonth()+1}.${sDate.getDate()} ~ ${eDate.getMonth()+1}.${eDate.getDate()}`;
                document.getElementById('weekly-range-text').innerText = `(${rangeText})`;
            }

            // 2. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ë‚´ì¼ë¶€í„° 6ì¼ê°„)
            for (let i = 1; i < 7; i++) {
                if(!data.daily.time[i]) break;
                
                const dateObj = new Date(data.daily.time[i]);
                const dayLabel = days[dateObj.getDay()];
                const max = Math.round(data.daily.temperature_2m_max[i]);
                const min = Math.round(data.daily.temperature_2m_min[i]);
                const info = getWeatherInfo(data.daily.weather_code[i]);

                container.innerHTML += `
                    <div class="daily-row">
                        <span class="daily-day">${dayLabel}ìš”ì¼</span>
                        <div class="daily-condition">
                            <img src="${info.icon}" class="daily-icon">
                            <span class="daily-text">${info.label}</span>
                        </div>
                        <div class="daily-temp">
                            <span class="min-temp">${min}Â°</span>
                            <span>${max}Â°</span>
                        </div>
                    </div>`;
            }
        }

        function renderNews(data) {
            const container = document.getElementById('news-list');
            container.innerHTML = '';
            const code = data.current.weather_code;
            let items = [];

            if (code >= 51) {
                items.push({e:"â˜”ï¸", t:"ë¹„ì˜¤ëŠ” ë‚  ë¹—ê¸¸ ì•ˆì „ ìš´ì „ ì£¼ì˜", m:"ì•ˆì „ êµí†µ ë‰´ìŠ¤"});
                items.push({e:"ğŸ§¥", t:"ìŒ€ìŒ€í•œ ë‚ ì”¨, ê²‰ì˜· ì±™ê¸°ì„¸ìš”", m:"ê±´ê°• ë¼ì´í”„"});
            } else if (code <= 3) {
                if (data.current.temperature_2m > 25) {
                    items.push({e:"â˜€ï¸", t:"ìì™¸ì„  ì§€ìˆ˜ ë†’ìŒ, ì„ í¬ë¦¼ í•„ìˆ˜", m:"í”¼ë¶€ ê±´ê°•"});
                } else {
                    items.push({e:"ğŸƒ", t:"ì‚°ì±…í•˜ê¸° ì¢‹ì€ ë‚ ì”¨, ê³µì› ì¶”ì²œ", m:"ë¼ì´í”„ìŠ¤íƒ€ì¼"});
                }
            }
            items.push({e:"ğŸ¥—", t:"í™˜ì ˆê¸° ë©´ì—­ë ¥ ë†’ì´ëŠ” ìŒì‹ 5ê°€ì§€", m:"ê±´ê°• ì •ë³´"});

            items.forEach(item => {
                container.innerHTML += `
                    <div class="news-item">
                        <div class="news-thumb">${item.e}</div>
                        <div class="news-content">
                            <div class="news-headline">${item.t}</div>
                            <div class="news-meta">${item.m}</div>
                        </div>
                    </div>`;
            });
        }

        function getWeatherInfo(code) {
            // WMO ì½”ë“œ í•´ì„ ë° í…ìŠ¤íŠ¸ ë§¤í•‘
            let label = "ë§‘ìŒ";
            let iconCode = "01d";
            
            if (code === 0) { label="ë§‘ìŒ"; iconCode="01d"; }
            else if (code === 1) { label="ëŒ€ì²´ë¡œ ë§‘ìŒ"; iconCode="02d"; }
            else if (code === 2) { label="êµ¬ë¦„ ì¡°ê¸ˆ"; iconCode="03d"; }
            else if (code === 3) { label="íë¦¼"; iconCode="04d"; }
            else if (code <= 48) { label="ì•ˆê°œ"; iconCode="50d"; }
            else if (code <= 55) { label="ì´ìŠ¬ë¹„"; iconCode="09d"; }
            else if (code <= 67) { label="ë¹„"; iconCode="10d"; }
            else if (code <= 77) { label="ì§„ëˆˆê¹¨ë¹„"; iconCode="13d"; }
            else if (code <= 82) { label="ì†Œë‚˜ê¸°"; iconCode="09d"; }
            else if (code <= 86) { label="ëˆˆ"; iconCode="13d"; }
            else if (code >= 95) { label="ë‡Œìš°"; iconCode="11d"; }

            return {
                label: label,
                icon: `https://openweathermap.org/img/wn/${iconCode}@2x.png`
            };
        }

        // =========================================
        // [ì¶”ê°€ë¨] ì•ŒëŒ ê´€ë ¨ í•¨ìˆ˜ë“¤ (reminder.htmlì—ì„œ ì´ì‹)
        // =========================================

        function unlockAudio() {
            sound1.play().then(() => { sound1.pause(); sound1.currentTime = 0; }).catch(() => {});
            sound2.play().then(() => { sound2.pause(); sound2.currentTime = 0; }).catch(() => {});
        }

        function loadReminders() {
            fetch(`${API_URL}/get-reminders`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name: userName })
            })
            .then(res => res.json())
            .then(data => {
                reminders = data.reminders || [];
            })
            .catch(err => console.log('ë¦¬ë§ˆì¸ë” ë¡œë“œ ì‹¤íŒ¨:', err));
        }

        function checkAlarm() {
            const now = new Date();
            if(now.getSeconds() !== 0) return;
            const timeStr = now.toTimeString().substring(0, 5);
            const dateStr = now.toISOString().split('T')[0];
            const day = now.getDay();

            reminders.forEach(r => {
                let trigger = false;
                if(r.time === timeStr) {
                    if(r.repeat_type === 'daily') trigger = true;
                    if(r.repeat_type === 'none' && r.target_date === dateStr) trigger = true;
                    if(r.repeat_type === 'weekly' && r.repeat_days.split(',').map(Number).includes(day)) trigger = true;
                    if(r.repeat_type === 'weekly_once' && isSameWeek(dateStr, r.target_date)) {
                        if(r.repeat_days.split(',').map(Number).includes(day)) trigger = true;
                    }
                }
                if(trigger) triggerAlarm(r);
            });

            snoozedAlarms.forEach((item, idx) => {
                if(item.triggerTime === timeStr) {
                    triggerAlarm(item.original);
                    snoozedAlarms.splice(idx, 1);
                }
            });
        }

        function isSameWeek(date1Str, date2Str) {
            const d1 = new Date(date1Str);
            const d2 = new Date(date2Str);
            const d1Sun = new Date(d1); d1Sun.setDate(d1.getDate() - d1.getDay());
            const d2Sun = new Date(d2); d2Sun.setDate(d2.getDate() - d2.getDay());
            return d1Sun.toDateString() === d2Sun.toDateString();
        }

        function triggerAlarm(r) {
            activeAlarm = r;
            document.getElementById('alarmTitleText').innerText = r.title;
            document.getElementById('alarmSubText').innerText = `${r.title}ì„/ë¥¼ í•  ì‹œê°„ì…ë‹ˆë‹¤.`;
            document.getElementById('alarmOverlay').style.display = 'flex';
            
            sound1.currentTime = 0;
            sound2.currentTime = 0;
            sound1.play().then(() => {
                sound1.onended = () => {
                    sound2.play();
                };
            }).catch(e => console.log("Audio Error:", e));
        }

        function stopAlarm() { 
            closeOverlay(); 
        }
        
        function snoozeAlarm() {
            closeOverlay();
            if(activeAlarm && activeAlarm.snooze > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + activeAlarm.snooze);
                snoozedAlarms.push({ triggerTime: now.toTimeString().substring(0,5), original: activeAlarm });
                showAlert(`${activeAlarm.snooze}ë¶„ ë’¤ ë‹¤ì‹œ ì•Œë¦½ë‹ˆë‹¤`, true);
            }
        }
        
        function closeOverlay() {
            document.getElementById('alarmOverlay').style.display = 'none';
            sound1.pause();
            sound2.pause();
            sound1.currentTime = 0;
            sound2.currentTime = 0;
            sound1.onended = null;
        }

        function showAlert(msg, isSuccess) {
            const m = document.getElementById('alertModal');
            const icon = document.getElementById('alertIcon');
            document.getElementById('alertMsg').innerText = msg;
            icon.style.display = isSuccess ? 'block' : 'none';
            if(isSuccess) {
                icon.style.animation = 'none';
                icon.offsetHeight; 
                icon.style.animation = 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }
            m.style.display = 'flex';
        }
        
        function closeAlert() { document.getElementById('alertModal').style.display = 'none'; }
    </script>
</body>
</html>
